name: Build MiniPNG

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

jobs:
  build:
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: macos-14
          - arch: x86_64
            runner: macos-13

    runs-on: ${{ matrix.runner }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '5.9'

      - name: Install Dependencies
        run: |
          brew install pngquant mozjpeg gifsicle webp oxipng libpng

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build Release
        run: |
          swift build -c release

      - name: Create App Bundle
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          APP_NAME="MiniPNG"
          APP_DIR="dist/$APP_NAME.app"
          
          # Create bundle structure
          mkdir -p "$APP_DIR/Contents/MacOS"
          mkdir -p "$APP_DIR/Contents/Resources/bin"
          
          # Copy executable
          cp ".build/release/$APP_NAME" "$APP_DIR/Contents/MacOS/"
          
          # Copy compression tools
          cp /opt/homebrew/bin/pngquant "$APP_DIR/Contents/Resources/bin/" 2>/dev/null || \
          cp /usr/local/bin/pngquant "$APP_DIR/Contents/Resources/bin/" || true
          
          cp /opt/homebrew/opt/mozjpeg/bin/cjpeg "$APP_DIR/Contents/Resources/bin/" 2>/dev/null || \
          cp /usr/local/opt/mozjpeg/bin/cjpeg "$APP_DIR/Contents/Resources/bin/" || true
          
          cp /opt/homebrew/opt/mozjpeg/bin/djpeg "$APP_DIR/Contents/Resources/bin/" 2>/dev/null || \
          cp /usr/local/opt/mozjpeg/bin/djpeg "$APP_DIR/Contents/Resources/bin/" || true
          
          cp /opt/homebrew/bin/gifsicle "$APP_DIR/Contents/Resources/bin/" 2>/dev/null || \
          cp /usr/local/bin/gifsicle "$APP_DIR/Contents/Resources/bin/" || true
          
          cp /opt/homebrew/bin/cwebp "$APP_DIR/Contents/Resources/bin/" 2>/dev/null || \
          cp /usr/local/bin/cwebp "$APP_DIR/Contents/Resources/bin/" || true
          
          cp /opt/homebrew/bin/oxipng "$APP_DIR/Contents/Resources/bin/" 2>/dev/null || \
          cp /usr/local/bin/oxipng "$APP_DIR/Contents/Resources/bin/" || true
          
          # Copy mozjpeg dependencies and fix paths
          mkdir -p "$APP_DIR/Contents/Frameworks"
          
          # Copy libjpeg from mozjpeg
          MOZJPEG_LIB=$(dirname $(which cjpeg 2>/dev/null || echo "/opt/homebrew/opt/mozjpeg/bin/cjpeg"))/../lib
          if [ -f "$MOZJPEG_LIB/libjpeg.62.dylib" ]; then
            cp "$MOZJPEG_LIB/libjpeg.62.dylib" "$APP_DIR/Contents/Frameworks/"
          elif [ -f "/opt/homebrew/opt/mozjpeg/lib/libjpeg.62.dylib" ]; then
            cp "/opt/homebrew/opt/mozjpeg/lib/libjpeg.62.dylib" "$APP_DIR/Contents/Frameworks/"
          elif [ -f "/usr/local/opt/mozjpeg/lib/libjpeg.62.dylib" ]; then
            cp "/usr/local/opt/mozjpeg/lib/libjpeg.62.dylib" "$APP_DIR/Contents/Frameworks/"
          fi
          
          # Copy libpng
          if [ -f "/opt/homebrew/opt/libpng/lib/libpng16.16.dylib" ]; then
            cp "/opt/homebrew/opt/libpng/lib/libpng16.16.dylib" "$APP_DIR/Contents/Frameworks/"
          elif [ -f "/usr/local/opt/libpng/lib/libpng16.16.dylib" ]; then
            cp "/usr/local/opt/libpng/lib/libpng16.16.dylib" "$APP_DIR/Contents/Frameworks/"
          fi
          
          # Fix dylib install names
          if [ -f "$APP_DIR/Contents/Frameworks/libjpeg.62.dylib" ]; then
            install_name_tool -id "@rpath/libjpeg.62.dylib" "$APP_DIR/Contents/Frameworks/libjpeg.62.dylib"
          fi
          if [ -f "$APP_DIR/Contents/Frameworks/libpng16.16.dylib" ]; then
            install_name_tool -id "@rpath/libpng16.16.dylib" "$APP_DIR/Contents/Frameworks/libpng16.16.dylib"
          fi
          
          # Fix library paths for cjpeg and djpeg
          # Use @loader_path since tools are in Resources/bin, not MacOS
          for tool in cjpeg djpeg; do
            if [ -f "$APP_DIR/Contents/Resources/bin/$tool" ]; then
              # @loader_path is the directory containing the binary (Resources/bin)
              # So ../../Frameworks goes to Contents/Frameworks
              install_name_tool -add_rpath "@loader_path/../../Frameworks" "$APP_DIR/Contents/Resources/bin/$tool" 2>/dev/null || true
              install_name_tool -change "@rpath/libjpeg.62.dylib" "@loader_path/../../Frameworks/libjpeg.62.dylib" "$APP_DIR/Contents/Resources/bin/$tool" 2>/dev/null || true
              install_name_tool -change "/opt/homebrew/opt/mozjpeg/lib/libjpeg.62.dylib" "@loader_path/../../Frameworks/libjpeg.62.dylib" "$APP_DIR/Contents/Resources/bin/$tool" 2>/dev/null || true
              install_name_tool -change "/usr/local/opt/mozjpeg/lib/libjpeg.62.dylib" "@loader_path/../../Frameworks/libjpeg.62.dylib" "$APP_DIR/Contents/Resources/bin/$tool" 2>/dev/null || true
              install_name_tool -change "/opt/homebrew/opt/libpng/lib/libpng16.16.dylib" "@loader_path/../../Frameworks/libpng16.16.dylib" "$APP_DIR/Contents/Resources/bin/$tool" 2>/dev/null || true
              install_name_tool -change "/usr/local/opt/libpng/lib/libpng16.16.dylib" "@loader_path/../../Frameworks/libpng16.16.dylib" "$APP_DIR/Contents/Resources/bin/$tool" 2>/dev/null || true
            fi
          done
          
          # Verify tools have correct dependencies
          echo "=== Checking cjpeg dependencies ==="
          otool -L "$APP_DIR/Contents/Resources/bin/cjpeg" 2>/dev/null || true
          echo "=== Checking Frameworks ==="
          ls -la "$APP_DIR/Contents/Frameworks/" 2>/dev/null || true
          
          # Create Info.plist
          cat > "$APP_DIR/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>zh_CN</string>
              <key>CFBundleExecutable</key>
              <string>$APP_NAME</string>
              <key>CFBundleIdentifier</key>
              <string>com.minipng.app</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>$APP_NAME</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
          </dict>
          </plist>
          EOF
          
          # Create PkgInfo
          echo -n "APPL????" > "$APP_DIR/Contents/PkgInfo"
          
          # Copy icon
          cp Sources/Resources/AppIcon.icns "$APP_DIR/Contents/Resources/"
          
          # Set permissions
          chmod +x "$APP_DIR/Contents/MacOS/$APP_NAME"
          chmod +x "$APP_DIR/Contents/Resources/bin/"* 2>/dev/null || true
          
          # Ad-hoc code signing (allows "Open Anyway" option)
          codesign --force --deep --sign - "$APP_DIR"

      - name: Create DMG
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          DMG_NAME="MiniPNG-${VERSION}-${ARCH}.dmg"
          
          # Create temp dir for DMG contents
          TMP_DIR=$(mktemp -d)
          cp -r dist/MiniPNG.app "$TMP_DIR/"
          ln -s /Applications "$TMP_DIR/Applications"
          
          # Create DMG
          hdiutil create -volname "MiniPNG" \
            -srcfolder "$TMP_DIR" \
            -ov -format UDZO \
            "dist/$DMG_NAME"
          
          rm -rf "$TMP_DIR"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MiniPNG-${{ steps.version.outputs.version }}-${{ matrix.arch }}
          path: dist/*.dmg

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
